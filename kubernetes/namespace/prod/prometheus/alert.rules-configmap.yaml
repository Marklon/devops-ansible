apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alert-rules
data:
  alert.rules: |-
    ## alert.rules ##

    # Alert for any instance that is unreachable for >5 minutes.
    # ALERT InstanceDown
    #   IF up == 0
    #   FOR 1m
    #   LABELS { severity = "page" }
    #   ANNOTATIONS {
    #     summary = "Instance {{ $labels.instance }} down",
    #     description = "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.",
    #   }

    ALERT LivePeasantInstancesActive
      IF count(up{caste="peasant"}) <= 5
      FOR 10m
      LABELS { severity = "page" }
      ANNOTATIONS {
        summary = "The number of peasant instances is below 5",
        description = "",
      }

    ALERT HighCPU
      IF ((sum(node_cpu{mode=~"user|nice|system|irq|softirq|steal|idle|iowait"}) by (instance, job)) - ( sum(node_cpu{mode=~"idle|iowait"}) by (instance,job) )   )   /  (sum(node_cpu{mode=~"user|nice|system|irq|softirq|steal|idle|iowait"}) by (instance, job)) * 100 > 95
      FOR 10m
      LABELS { severity = "page" }
      ANNOTATIONS {
        summary = "High CPU Usage",
        description = "This machine {{ $labels.instance }} has really high CPU usage for over 10m",
      }

    ALERT LowMemoryPercentFree
      IF (node_memory_MemTotal - node_memory_MemFree )/ node_memory_MemTotal * 100 < 4
      FOR 15m
      LABELS { severity = "page" }
      ANNOTATIONS {
        summary = "Low Memory Percent Free",
        description = "This machine {{ $labels.instance }} memory is lower than 4% free for the last 30m",
      }
